# 系统调用

[TOC]

## 一、定义

[系统调用是内核提供给应用程序使用的功能函数，由于应用程序一般运行在用户态，处于用户态的进程有诸多限制（如不能进行 I/O 操作），所以有些功能必须由内核代劳完成](https://zhuanlan.zhihu.com/p/469222123)[。系统调用是一种软中断处理程序，用于让程序从用户态陷入内核态，以执行相应的操作](https://zhuanlan.zhihu.com/p/289410487)。

## 二、分类

常用的 Linux 系统调用有：

- read()、write()、open()、close() 等用于文件操作的系统调用
- fork()、exec()、wait()、exit() 等用于进程管理的系统调用
- socket()、bind()、listen()、accept() 等用于网络通信的系统调用
- mmap()、munmap()、brk() 等用于内存管理的系统调用
- signal()、sigaction() 等用于信号处理的系统调用

## 三、工作流程

根据搜索结果，我为你制作了一个图表，详细解释了发生系统调用时 Linux 如何协调应用层和内核层完成工作的。图表如下：

```code
+------------------+     +------------------+     +------------------+
|                  |     |                  |     |                  |
|   应用程序        |     |   C库            |      |   内核           |
|                  |     |                  |     |                  |
+------------------+     +------------------+     +------------------+
        ^                       ^                       ^
        |                       |                       |
        v                       v                       v
+-------+-------+         +-----+-----+         +-----+-----+
|       1       <--------->  2  svc   <--------->  3  中断   |
| 调用C库函数    <---------+ 指令    +<---------+     处理程序  |
|       ^       <--------->       ^   <--------->       ^   |
+-------v-------+         +-------v---+         +-------v---+
        ^                       ^                       ^
        |                       |                       |
        v                       v                       v
        +-------------------------------------------------+
                            系统调用号
                            参数
                            返回值
```

图中的数字表示系统调用的流程：

1. 应用程序调用 C 库函数，传入参数。
2. C 库函数执行 svc 指令，触发软件中断，将系统调用号、参数和返回值寄存器的地址压入栈中。
3. 中断处理程序根据系统调用号，在系统调用表中查找对应的内核函数，并执行它。
4. 内核函数完成相应的操作，并将返回值写入返回值寄存器的地址。
5. 中断处理程序恢复栈中的内容，并返回到 C 库函数。
6. C 库函数从返回值寄存器读取返回值，并返回到应用程序。

参考文献：

[Linux系统调用详解（实现机制分析） - 知乎.]( https://zhuanlan.zhihu.com/p/267353577) 

[Linux 系统调用分析：陷入内核 - 知乎.]( https://zhuanlan.zhihu.com/p/351917992 )

[arm-linux 系统调用流程 - 知乎.](https://zhuanlan.zhihu.com/p/363290974)



## 四、系统调用解析

### 1、文件系统相关

#### read解析

##### 程序

Linux使用read系统调用的例程：

```c
/*
     应用程序
 */ 

#include <stdio.h>
#include <unistd.h>

int main() 
{
    char buf[100];
    int n = read(0, buf, sizeof(buf)); // 调用read函数，从标准输入读取数据到buf中
    if (n == -1) 
    {
        perror("read error");
    } 
    else 
    {
        printf("read %d bytes: %s\n", n, buf); // 打印读取到的数据
    }
    return 0;
}

/*
      C库
 */ 

ssize_t read(int fd, void *buf, size_t count) 
{
    ssize_t ret;
    asm volatile (
      "movl $3, %%eax\n" // 系统调用号3为read
      "movl %1, %%ebx\n" // 第一个参数fd放入ebx寄存器
      "movl %2, %%ecx\n" // 第二个参数buf放入ecx寄存器
      "movl %3, %%edx\n" // 第三个参数count放入edx寄存器
      "int $0x80\n"      // 触发软件中断，进入内核态
      "movl %%eax, %0\n" // 将返回值放入ret变量中 
      : "=m"(ret) 
      : "m"(fd), "m"(buf), "m"(count)
      : "%eax", "%ebx", "%ecx", "%edx"
    );
    return ret; // 返回读取到的字节数或错误码 
}

/*
 *    内核
 */ 

asmlinkage ssize_t sys_read(unsigned int fd,char __user *buf,size_t count) 
{
	// 实现文件操作逻辑，并将结果写入buf和count变量中 
}
```

##### 流程图

当Linux的应用层调用了`read`之后，工作流程如下

```code
+------------------+     +------------------+     +------------------+
|                  |     |                  |     |                  |
|   应用程序        |     |   C库             |     |   内核           |
|                  |     |                  |     |                  |
+------------------+     +------------------+     +------------------+
        ^                       ^                       ^
        |                       |                       |
        v                       v                       v
+-------+-------+         +-----+-----+         +-----+-----+
|       1       <--------->  2  int   <--------->  3  中断   |
| 调用read函数    <---------+ 0x80    +<---------+ 处理程序    |
|       ^       <--------->       ^   <--------->       ^   |
+-------v-------+         +-------v---+         +-------v---+
        ^                       ^                       ^
        |                       |                       |
        v                       v                       v
        +-------------------------------------------------+
                            系统调用号
                            参数
                            返回值
```

图中的数字表示系统调用的流程：

1. 应用程序调用 `read `函数，传入文件描述符` fd`、缓冲区` buf` 和读取字节数` count`。
2. read 函数执行` int 0x80` 指令，触发软件中断，将系统调用号、参数和返回值寄存器的地址压入栈中。
3. 中断处理程序根据系统调用号，在系统调用表中查找对应的内核函数 `sys_read`，并执行它。
4. `sys_read `函数完成相应的文件操作，并将返回值写入返回值寄存器的地址。
5. 中断处理程序恢复栈中的内容，并返回到` read `函数。
6. `read` 函数从返回值寄存器读取返回值，并返回到应用程序。

### 2、进程管理相关

### 3、网络通信相关

### 4、内存管理相关

### 5、信号处理相关

