# IIC的上拉电阻

I2C为什么要接上拉电阻？因为它是开漏输出。

![](https://pic-1304959529.cos.ap-guangzhou.myqcloud.com/DB/20220326194100.png)

- **为什么是开漏输出？**

  - 推挽输出和开漏输出

    - 推挽输出: 

      输出逻辑0，则N-MOS激活；

      输出逻辑1，则P-MOS激活。

    - 开漏输出:

      在不接上拉电阻时, 输出逻辑0，则N-MOS激活；

      输出逻辑1，P-MOS不会激活, 不会输出高电平。

      在接上拉电阻时, 输出逻辑0，则N-MOS激活；

      输出逻辑1，P-MOS激活, 可以输出高电平。

也就是说开漏输出如果不接上拉电阻, 没有输出高电平的能力。	
  如果需要开漏输出有输出高电平的能力需要接一个上拉电阻. 目前很多单片机GPIO可以通过软件配置上拉电阻.

![](https://pic-1304959529.cos.ap-guangzhou.myqcloud.com/DB/20220326194116.png)

 *左图为开漏输出(接上拉电阻), 右图为推挽输出*

  - 防止短路: 在一些情况下(比如总线), 多个GPIO口可能会连接在同一根线上, 存在某个GPIO输出高电平, 另一个GPIO输出低电平的情况. 如果使用推挽输出, 你会发现这个GPIO的VCC和另一个GPIO的GND接在了一起, 也就是短路了(凉凉了). 如果换成开漏输出呢? VCC和GND多了个电阻, 这样电路就是安全的.所以总线一般会使用开漏输出。

  - ![](https://pic-1304959529.cos.ap-guangzhou.myqcloud.com/DB/20220326194334.png)

     线与: 开漏输出还能实现线与, 减少一个与门, 简化电路。

- **上拉电阻阻值怎么确定？**

  - 一般IO端口的驱动能力在2mA～4mA量级。
  - **阻值不能过小。**
    - 功耗问题。如果上拉阻值过小，VDD灌入端口的电流将较大，功耗会很大，导致端口输出的低电平值增大(I2C协议规定，端口输出低电平的最高允许值为0.4V)。故通常上拉电阻应选取不低于1K的电阻（当VDD＝3V时，灌入电流不超过3mA）。
  - **阻值不能过大。**
    - 速度问题。它取决于上拉电阻和线上电容形成的RC延时，RC延时越大，波形越偏离方波趋向于正弦波，数据读写正确的概率就越低，所以上拉电阻不能过大。
    - I2C总线上的负载电容不能超过400pF。当I2C总线上器件逐渐增多时，总线负载电容也相应增加。当总的负载电容大于400pF时，就不能可靠的工作。这也是I2C的局限性。建议上拉电阻可选用1.5K，2.2K，4.7K。

- **I2C总线基本操作**

  - 根据I2C总线规范，总线空闲时两根线都必须为高。假设主设备A需要启动I2C，他需要在SCL高电平时，将SDA由高电平转换为低电平作为启动信号。

  - 主设备A在把SDA拉高后，它需要再检查一下SDA的电平。为什么? 因为线与，如果主设备A拉高SDA时，已经有其他主设备将SDA拉低了，由于 1 & 0 = 0 那么主设备A在检查SDA电平时, 会发现不是高电平，而是低电平。说明其他主设备抢占总线的时间比它早，主设备A只能放弃占用总线。如果SDA是高电平，说明主设备A可以占用总线，然后主设备A将SDA拉低，开始通信。

    这就是开漏输出在IIC通信中的另一个作用。

    SDA是高电平, 说明主设备A可以占用总线, 然后主设备A将SDA拉低, 开始通信；

    SDA是低电平, 说明有人已经捷足先登了, 主设备A不能占用总线, 结束通信。

  - 因此，模拟I2C一定要将GPIO端口设置为开漏输出并加上拉电阻。