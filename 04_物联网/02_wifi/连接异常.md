# 连接异常

## 当你连接到一个不存在的 IP 时会发生什么

*第一个情况：目标 IP 地址和客户端的 IP 地址是同一个局域网（网络号相同）。*

第一种情况，客户端无法发出 SYN 报文，主要卡在数据链路层。

因为目标地址不存在 IP 地址，客户端的内核在发 arp 请求的时候，广播询问这个目标 IP 地址是谁的，由于网络中不存在该目标 IP 地址，所以没有设备应答客户端的 arp 请求。

由于**客户端无法拿到目标设备的 MAC，这样就没办法组装 MAC 头的信息，所以 SYN 报文无法发送出去**。

*第二个情况：目标 IP 地址和客户端的 IP 地址不在同一个局域网（网络号不同）。*

第二种情况，客户端会先将 SYN 报文发给路由器，然后路由器会继续转发。

由于目标 IP 地址是不存在的，该 SYN 报文会在网络中消亡，因此客户端是不会收到对 SYN 报文的确认报文的，接着**客户端会触发超时重传，重传 SYN 报文，直到重传的次数达到最大次数后，客户端的连接就会被释放**。

可能有的同学好奇，为什么这种情况客户端的 SYN 报文可以发出来？

因为当目标 IP 地址和客户端 IP 地址不在同一个局域网时，客户端客通过路由表的判断，判断到下一步是要将网络报文发送给路由器。

![image-20230216144406905](https://pic-1304959529.cos.ap-guangzhou.myqcloud.com/DB/image-20230216144406905.png)

这时候数据链路层的 arp 请求，会广播询问 IP 地址（路由器 IP 地址)是谁的，路由器发现是自己的 IP 地址，于是就会将自己的 MAC 地址告诉客户端。

然后客户端的网络报文中 MAC 头的「目标 MAC 地址」填入的就是路由器的 MAC 地址，于是 SYN 报文就可以发送出去了。

由于目标 MAC 地址是路由器的，所以就会被路由器接收，然后路由器继续通过路由表的判断，转发给下一个路由器，直到找到目标设备。

## 当客户端连接到一个存在的 IP 地址但端口不存在时会发生什么？

当客户端连接到一个存在的IP地址但端口不存在时，连接将无法建立。这是因为连接需要 IP 地址和端口号均有效且可用。

在这种情况下，客户端和服务器的行为可能取决于所使用的协议，但一般来说，可能会发生以下情况：

1. TCP/IP 连接：如果您使用的是 TCP/IP 连接，客户端将向指定 IP 地址和端口号的服务器发送 SYN 数据包。如果端口号不存在，服务器会回复一个RST包，表示端口关闭。客户端会收到这个RST包并报错，比如“connection refused”或者“port unreachable”。
2. HTTP(S) 请求：如果您向未打开指定端口的服务器发出 HTTP(S) 请求，客户端会将请求发送到指定的 IP 地址和端口号。服务器将响应一个错误，例如“HTTP 错误 404 - 未找到”或“连接被拒绝”，表明所请求的资源或服务在指定端口不可用。

在这两种情况下，客户端都会报告一个错误，表明连接不成功，设备或应用程序将无法通过指定的 IP 地址和端口号与服务器通信。